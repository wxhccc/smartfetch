!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios")):"function"==typeof define&&define.amd?define(["exports","axios"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Smartfetch={},e.axios)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(t);const s={credentitals:"same-origin",responseType:"json"},r={json:"json",text:"text",blob:"blob",arraybuffer:"arrayBuffer"},{hasOwnProperty:i,toString:c}=Object.prototype,a=e=>"[object Object]"===c.call(e);function f(e,t,n,o){const c=e,f="unknown"!==o;e.$core;let u=e.$curCfg,l=null,h=null,p=!!e.options.responseCheck;const d=f?"react"===o?"state":"":"$_SF_KEYS",g=d?t[d]:t;let y,b,C,j={},_=!1,O=[];const S=e=>(l=e,e.data),E=e=>{e&&"string"==typeof e&&c.baseConfigs[e]&&(u=c.baseConfigs[e],!c.useFetch&&c.axiosCores[e])},x=e=>{e.useCore&&"string"==typeof e.useCore&&(E(e.useCore),delete e.useCore)},w=e=>{const{baseURL:t,headers:n}=u||{};return e.url||(e.url=""),t&&(e.url||"").indexOf("http")<0&&(e.url=t+e.url),n&&(e.headers={...e.headers,...n}),j=Object.assign({},s,e),c.$core(e.url,j).then(T).then(A)},m=e=>{const{dataKey:t}=c.options;return t?e[t]:e},k=()=>O.length>0&&v(g,O),$=e=>{if(O.length)return D(g,O,e);b&&(b[0][b[1]]=e),y&&y(e)},v=(e,t)=>{if(b)return b[0][b[1]];let n=!1;if(e&&a(e)&&Array.isArray(t)){let o=e;for(let e=0;e<t.length;e++){const s=t[e];if("object"!=typeof o||!i.call(o,s))break;o=o[s],e===t.length-1&&(n="boolean"==typeof o&&o)}}return n},A=e=>{const{responseType:t}=j,n=r[t];return n&&"function"==typeof e[n]?e[n]():void 0},T=e=>{l=e;const{validateStatus:t}=c.options;if(t?t(e.status):e.ok)return e;throw new Error(`Request failed with status code ${e.status}`)},F=e=>{if("function"==typeof C&&C(e),_)return[e,void 0];let t="";const{statusMsgs:n,options:{errorHandler:o,codeErrorHandler:s},useFetch:r}=c;if(r&&e instanceof TypeError||"Network Error"===e.message)t="服务器未响应";else if(e instanceof SyntaxError)t="数据解析失败";else if(e instanceof RangeError||e.response){e.response&&(l=e.response);const{status:o}=l;t=o&&n[o]||"请求失败"}return"CodeError"===e.name&&"function"==typeof s?s(h):"function"==typeof o?o(t,e,l||void 0):"function"==typeof alert?alert(t):console.error(e),[e,void 0]},P=e=>{if(p&&!(e=>{let t=!1;const{responseCheck:n}=c.options;return"function"==typeof n?t=n(e):"string"==typeof n&&(t=!!e[n]),t})(e))throw h=e,t="CodeError",o="code checked failed",(n=(n=void 0)instanceof Error?n:new Error).name=t,o&&(n.message=o),n;return e;var t,n,o},D=(e,n,s)=>{if("vue"===o&&t.$set&&!i.call(e,n[0]))return;const{$set:r=((e,t,n)=>{e[t]=n})}=t,c="react"===o,f=c?{...e}:e;let u=f,l=!1;for(let e=0;e<n.length;e++){const t=n[e],o=i.call(u,t);if(e===n.length-1){const e="boolean"==typeof u[t];l=!o||e,l&&r(u,t,s)}else{if(!o&&r(u,t,{}),!a(u[t]))break;c&&(u[t]={...u[t]}),u=u[t]}}c&&l&&t.setState({[n[0]]:f[n[0]]})};return(e=>{let t;const n=[];e&&"string"==typeof e.url?(x(e),t=Promise.resolve().then((()=>{if(!k()){$(!0);const t=(c.useFetch?w(e):(e=>(0,c.$core)(e).then(S))(e)).then(P).then(m);return(n.length?n.reduce(((e,t)=>e.then(t)),t):t.then((e=>[null,e]))).catch(F).finally((()=>$(!1)))}}))):t=Promise.reject(new Error("smartfetch: no valid url")).catch(F);const o=Object.assign(t,{done:e=>(n.push(e),o),faile:e=>(C=e,t),useCore:e=>(e&&E(e),o),lock:(e,t)=>{const n=e=>Array.isArray(e)&&2===e.length;return"string"==typeof e?O=e.split("."):n(e)?b=e:"function"==typeof e&&(y=e,n(t)&&(b=t)),o},silence:()=>(_=!0,o),notCheckCode:()=>(p=!1,o)});return o})(n)}const{hasOwnProperty:u,toString:l}=Object.prototype,h=e=>{const t=l.call(e).match(/^\[object (.*)\]$/);return t?t[1]:""},p=["GET","HEAD","POST","PUT","DELETE","OPTIONS","PATCH"],d={json:"application/json",urlencode:"application/x-www-form-urlencoded",text:"text/plain"};function g(e){const t=[],n=e=>encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]");return Object.keys(e).forEach((o=>{const s=e[o];if(null==s)return;const r=Array.isArray(s)?s:[s];Array.isArray(s)&&(o+="[]"),r.forEach((e=>{e instanceof Date?e=e.toISOString():"Object"===h(e)&&(e=JSON.stringify(e)),t.push(n(o)+"="+n(e))}))})),t.join("&")}function y(e,t,n){const o=function(e,t){if(!t)return e;let n="";if(n=t instanceof URLSearchParams?t.toString():g(t),n){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e}(e,t);if(e.indexOf("http")>=0)return o;return(n&&n.baseURL?n.baseURL:"")+o}function b(e){return function(...t){const n=function(e){return e?e._isVue||e.$&&e.$.vnode?"vue":"setState"in e?"react":"unknown":"unknown"}(this),o=t[0],s="string"==typeof o?_(...t):o||{},r="unknown"!==n?this:self||window||global;var i,c;return r&&"unknown"===n&&(i=r,c="$_SF_KEYS",!u.call(i,c))&&(r.$_SF_KEYS={}),f(e,r,s,n)}}class C{constructor(e){this._fetchEnable=!1,this._useFetch=!0,this._axiosCores=Object.create(null),this._baseCfgs=Object.create(null),this._statusMsgs=Object.create(null),this.$curCfg=Object.create(null),this._options={},this.fetch=b(this),this.resetOptions(e),this._fetchCoreChoose(!(!e||!e.forceAxios))}get useFetch(){return this._useFetch}get axiosCores(){return this._axiosCores}get baseConfigs(){return this._baseCfgs}get statusMsgs(){return this._statusMsgs}get options(){return this._options}_fetchCoreChoose(e){this._fetchEnable="function"==typeof fetch,this._ajaxCoreSwitch(e||!this._fetchEnable)}_ajaxCoreSwitch(e){Object.assign(this,{_useFetch:!e,$core:e?o.default:fetch.bind(window||global)})}_fetchCoreSetup(e){const{_axiosCores:t,_baseCfgs:n,_useFetch:s}=this;(Array.isArray(e)?e.length?e:[{key:"default"}]:[{key:"default",...e}]).forEach((e=>{const r=Object.assign({},e),{key:i}=r;i&&(delete r.key,n[i]=r,!s&&(t[i]=o.default.create(e)))})),this.$curCfg=n.default,!s&&(this.$core=t.default)}install(e,t){t&&t instanceof Object&&this.resetOptions(t),"globalProperties"in e.config?e.config.globalProperties.$fetch=this.fetch:e.prototype.$fetch=this.fetch}modifyBaseConfigs(e){"function"==typeof e&&e(this._baseCfgs)}resetOptions(e={},t){(e||"Object"===h(e))&&(this._options=t?e:{...this._options,...e},this._ajaxCoreSwitch(!!e.forceAxios),e.baseConfigs&&this._fetchCoreSetup(e.baseConfigs))}}const j=new C,_=function(e){let t="default";const{useFetch:n,options:o,baseConfigs:s}=e;function r(e,r={},i="GET",c){i=p.includes(i)?i:"GET";const a=["GET","HEAD"].includes(i),{baseData:f}=o,u="function"==typeof f?f(t):f,l=r instanceof FormData,b={...u,...l?{}:r},{returnLink:C,enctype:j}={returnLink:!1,enctype:"json",...c};if(C&&a){return y(e,b,s&&s[t]?s[t]:void 0)}const _={url:e,method:n?i:i.toLowerCase(),useCore:t};return"none"!==j&&(_.headers={"Content-Type":d[j]?d[j]:d.json}),n&&"json"!==j&&(_.responseType="blob"),Object.keys(b).length?a?(n?_.url+=`?${g(b)}`:_.params=r,_):(u&&l&&function(e,t){if(t&&e instanceof FormData)for(const n in t){if(e.has(n))continue;const o=t[n];["Number","String","Date"].indexOf(h(o))>-1?e.append(n,"Date"===h(o)?o.toISOString():String(o)):g(o).split("&").map((e=>e.split("="))).forEach((([t,n])=>t&&n&&e.append(t,n)))}}(r,b),n?_.body=l?r:"json"===j?JSON.stringify(r):g(r):_.data=l||"json"===j?r:g(r),_):_}return function(...e){t="default";const n=e[0];return"string"==typeof n?r(...e):n&&"string"==typeof n.useCore&&s[n.useCore]?(t=n.useCore,r):()=>{}}}(j);e.SmartFetch=C,e.default=j,e.request=_,Object.defineProperty(e,"__esModule",{value:!0})}));

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios"),require("query-string")):"function"==typeof define&&define.amd?define(["exports","axios","query-string"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Smartfetch={},e.axios,e.queryString)}(this,(function(e,t,s){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=o(t);const r={credentitals:"same-origin",responseType:"json"},i={json:"json",text:"text",blob:"blob",arraybuffer:"arrayBuffer"},{hasOwnProperty:c}=Object.prototype;function h(e,t,s){return(t=t instanceof Error?t:new Error).name=e,s&&(t.message=s),t}class a{constructor(e,t,s,o){this.__response=null,this.__resJson=null,this._silence=!1,this._codeCheckResult=!1,this._lockKey=[],this._useCoreKey="default",this._contextState={},this._fetchConfig={},this._handleResData=e=>{let t=e;try{const{dataKey:s}=this.$root.options;return s?e[s]:t}catch(e){throw h("CallbackSyntaxError",e)}},this._typeHandle=e=>{const{responseType:t}=this._fetchConfig,s=i[t];return console.log(111,t,s),s&&"function"==typeof e[s]?e[s]():void 0},this._resStatusCheck=e=>{this.__response=e;const{validateStatus:t}=this.$root.options;if(t?t(e.status):e.ok)return e;throw new RangeError(String(e.status))},this._handleError=e=>{const t="function"==typeof this._failHandler;if(t&&this._failHandler(e),this._silence){if(t)return e;throw e}let s="";const{statusMsgs:o,options:{errorHandler:n,codeErrorHandler:r},useFetch:i}=this.$root;if(i&&e instanceof TypeError||"Network Error"===e.message)s="服务器未响应";else if(e instanceof SyntaxError)s="数据解析失败";else if(e instanceof RangeError||e.response){e.response&&(this.__response=e.response);const{status:t}=this.__response;s=t&&o[t]||"请求失败"}if("CodeError"===e.name&&"function"==typeof r?r(this.__resJson):"CallbackSyntaxError"===e.name||("function"==typeof n?n(s,e,this.__response||void 0):"function"==typeof alert?alert(s):console.error(e)),t)return e;throw e},this._handleFinally=()=>{this._unlock()},this._codeCheck=e=>{if(this._needCodeCheck&&!this._resOkCheck(e))throw this.__resJson=e,h("CodeError",void 0,"code checked failed");return e},this.$root=e,this._context=t,this._useCore=e.$core,this._useBaseCfg=e.$curCfg,this._contentType=o,this._needCodeCheck=!!e.options.responseCheck,this._isReactiveIns="default"!==o;const n=o?"react"===o?"state":"":"$_SF_KEYS";this._contextState=n?this._context[n]:this._context,this._reqPromise=this._createRequest(s)}get $promise(){return this._reqPromise}_axiosRequest(e){return(0,this.$root.$core)(e).then(this._axiosResStatusCheck)}_axiosResStatusCheck(e){return this.__response=e,e.data}_createRequest(e){if(!e||"string"!=typeof e.url)return Promise.reject(new Error("smartfetch: no valid url"));this._checkRequestCore(e);const t=[],s=Promise.resolve().then((()=>{if(!this._checkLock()){this._lock();const s=(this.$root.useFetch?this._request(e):this._axiosRequest(e)).then(this._codeCheck).then(this._handleResData);return t.reduce(((e,t)=>e.then(t)),s).catch(this._handleError).finally(this._handleFinally)}}));return Object.assign(s,{then:e=>(t.push(e),s),catch:e=>(this._failHandler=e,s),useCore:this.useCore.bind(this),lock:e=>(e&&"string"==typeof e&&(this._lockKey=e.split("."),"vue"===this._contentType&&this._checkOrSetVueSAkeys()),s),silence:()=>(this._silence=!0,s),notCheckCode:()=>(this._needCodeCheck=!1,s)}),s}_checkRequestCore(e){e.useCore&&"string"==typeof e.useCore&&(this.useCore(e.useCore),delete e.useCore)}_request(e){const{baseURL:t,headers:s}=this._useBaseCfg||{};return e.url||(e.url=""),t&&(e.url||"").indexOf("http")<0&&(e.url=t+e.url),s&&(e.headers={...e.headers,...s}),this._fetchConfig=Object.assign({},r,e),this.$root.$core(e.url,this._fetchConfig).then(this._resStatusCheck).then(this._typeHandle)}_lock(){this._stateLock()}_unlock(){this._stateLock(!0)}_checkLock(){return this._lockKey&&this._getLockValue()}_stateLock(e){const{_lockKey:t,_contextState:s,_contentType:o}=this;t.length&&this["vue"===o?"_setVueValue":"_setAsyncValue"](s,t,!e)}_getLockValue(){const{_contextState:e,_lockKey:t}=this;return this._getValue(e,t)}_getValue(e,t){let s=!1;if(e&&"object"==typeof e&&Array.isArray(t)){let o=e;for(let e=0;e<t.length;e++){const n=t[e];if("object"!=typeof o||!c.call(o,n))break;o=o[n],e===t.length-1&&(s="boolean"==typeof o&&o)}}return s}_resOkCheck(e){let t=!1;const{responseCheck:s}=this.$root.options;return"function"==typeof s?t=s(e):"string"==typeof s&&(t=!!e[s]),this._codeCheckResult=t,t}_checkOrSetVueSAkeys(){const{_context:e,_lockKey:t,_isReactiveIns:s}=this,o=!c.call(e,t[0]);s&&o&&(!c.call(e,"SF_KEYS")&&e.$set("SF_KEYS",{}),this._contextState=e.SF_KEYS)}_setVueValue(e,t,s){const{$set:o=((e,t,s)=>{e[t]=s})}=this._context;let n=e;for(let e=0;e<t.length;e++){const r=t[e],i=c.call(n,r),h=i&&"object"==typeof n[r]&&n[r];if(e===t.length-1?i?!h&&(n[r]=s):o(n,r,s):!i&&o(n,r,{}),n=n[r],"object"!=typeof n)break}}_setAsyncValue(e,t,s){let o=e;for(let e=0;e<t.length;e++){const n=t[e];e===t.length-1?o[n]=s:("object"==typeof o&&!c.call(o,n)&&(o[n]={}),o=o[n])}t.length&&"react"===this._contentType&&this._context.setState({[t[0]]:this._contextState[t[0]]})}useCore(e){return e&&"string"==typeof e&&this.$root.baseConfigs[e]&&(this._useCoreKey=e,this._useBaseCfg=this.$root.baseConfigs[e],!this.$root.useFetch&&(this._useCore=this.$root.axiosCores[e])),this._reqPromise}}const u=["GET","HEAD","POST","PUT","DELETE","OPTIONS","PATCH"],l={json:"application/json",urlencode:"application/x-www-form-urlencoded",text:"text/plain"};const{hasOwnProperty:f,toString:_}=Object.prototype;function p(e){return function(...t){const s=function(e){return e._isVue||e.$&&e.$.vnode?"vue":"setState"in e?"react":"default"}(this),o=t.length?function(...e){const t=e[0];return"string"==typeof t?g(...e):"function"==typeof t?t(...e.slice(1)):{}}(...t):{},n=s?this:self||window||global;return n&&"default"===s&&!f.call(n,"$_SF_KEYS")&&(n.$_SF_KEYS={}),new a(e,n,o,s).$promise}}class d{constructor(e){this._fetchEnable=!1,this._useFetch=!0,this._axiosCores=Object.create(null),this._baseCfgs=Object.create(null),this._statusMsgs=Object.create(null),this.$curCfg=Object.create(null),this._options={},this.fetch=p(this),this.resetOpts(e),this._fetchCoreChoose(!(!e||!e.forceAxios))}get useFetch(){return this._useFetch}get axiosCores(){return this._axiosCores}get baseConfigs(){return this._baseCfgs}get statusMsgs(){return this._statusMsgs}get options(){return this._options}_fetchCoreChoose(e){this._fetchEnable="function"==typeof fetch,this._ajaxCoreSwitch(e||!this._fetchEnable)}_ajaxCoreSwitch(e){Object.assign(this,{_useFetch:!e,$core:e?n.default:fetch.bind(window||global)})}_fetchCoreSetup(e){const{_axiosCores:t,_baseCfgs:s,_useFetch:o}=this;(Array.isArray(e)?e.length?e:[{key:"default"}]:[{key:"default",...e}]).forEach((e=>{const r=Object.assign({},e),{key:i}=r;i&&(delete r.key,s[i]=r,!o&&(t[i]=n.default.create(e)))})),this.$curCfg=s.default,!o&&(this.$core=t.default)}install(e,t){t&&t instanceof Object&&this.resetOpts(t),"globalProperties"in e.config?e.config.globalProperties.$fetch=this.fetch:e.prototype.$fetch=this.fetch}modifyBaseConfigs(e){"function"==typeof e&&e(this._baseCfgs)}resetOpts(e={}){(e||"Object"===(e=>{const t=_.call(e).match(/^\[object (.*)\]$/);return t?t[1]:""})(e))&&(Object.assign(this._options,e),this._ajaxCoreSwitch(!!e.forceAxios),e.baseConfigs&&this._fetchCoreSetup(e.baseConfigs))}}const y=new d,g=function(e){let t="default";const{useFetch:o,options:n,baseConfigs:r}=e;function i(e,i={},c="GET",h=!1,a="json"){c=u.includes(c)?c:"GET";const f=["GET","HEAD"].includes(c),{baseData:_}=n,p="function"==typeof _?_(t):_,d=i instanceof FormData,y={...p,...d?{}:i};if(h&&f){return function(e,t,o){const n="?"+s.stringify(t);return e.indexOf("http")>=0?e+n:(o&&o.baseURL?o.baseURL:"")+e+n}(e,y,r&&r[t]?r[t]:void 0)}const g={url:e,method:o?c:c.toLowerCase(),useCore:t};return Object.keys(y).length?f?(o?g.url+=`?${s.stringify(y)}`:g.params=i,g):(p&&d&&function(e,t){if(t&&e instanceof FormData)for(let o in t){if(e.has(o))continue;const n=t[o];"number"==typeof n||"string"==typeof n?e.append(o,String(n)):s.stringify(n).split("&").map((e=>e.split("="))).forEach((([t,s])=>t&&s&&e.append(t,s)))}}(i,y),o?(g.headers=Object.assign(g.headers||{},{"Content-Type":l[a]?l[a]:l.json}),g.body=d?i:"json"===a?JSON.stringify(i):s.stringify(i)):g.data=d||"json"===a?i:s.stringify(i),g):g}return function(...e){t="default";const s=e[0];return"string"==typeof s?i(...e):s&&"string"==typeof s.useCore&&r[s.useCore]?(t=s.useCore,i):()=>{}}}(y);e.SmartFetch=d,e.default=y,e.request=g,Object.defineProperty(e,"__esModule",{value:!0})}));
